from mimetypes import inited

import aiohttp

from news import get_file_text

from openai import AsyncOpenAI
from config import config

client = AsyncOpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=config.deepseek_api
)

#
async def analyze_with_deepseek(messages) -> str:
    combined_text = "\n".join(msg if msg is not None else "" for msg in messages)
    old_news = get_file_text('old_news')
    old_public = get_file_text('old_public')

    inst = f"""
–¢—ã - —Ç—Ä–µ–π–¥–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º.

üîπ –ó–∞–¥–∞—á–∞:
–°–Ω–∞—á–∞–ª–∞ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—É—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ä—ã–µ.

–ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –Ω–æ–≤–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –¥–æ—Å–ª–æ–≤–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ –≤—Å–µ–º –∫–ª—é—á–µ–≤—ã–º –¥–µ—Ç–∞–ª—è–º, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π), —Å—Ä–∞–∑—É –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ null –∏ –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É —Ç—ã —ç—Ç–æ –≤–µ—Ä–Ω—É–ª.

–û–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç, —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π, –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ç.–¥. –¢–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–π –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π.
–£–¥–µ–ª–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º, —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å Dogecoin, –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º DOGE –≤ —Ç–µ–∫—Å—Ç–µ.

–¢–∞–∫–∂–µ —É–¥–µ–ª–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —Å–≤—è–∑–∞–Ω–Ω–∞—è —Å –§–†–°, –ø–æ–≤—ã—à–µ–Ω–∏–µ–º –∏–ª–∏ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ–º —Å—Ç–∞–≤–æ–∫, –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –î–ö–ü (–î–µ–Ω–µ–∂–Ω–æ-–ö—Ä–µ–¥–∏—Ç–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏).  
–ü–æ–≤—ã—à–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫, —Å–º—è–≥—á–µ–Ω–∏–µ –î–ö–ü –æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä—è–º–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Ä—ã–Ω–æ–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∏ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä—ã–Ω–∫–∏.

–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏:
- üêïüêïüêï Dogecoin (DOGE)
- üí∏‚ö†Ô∏è‚ÄºÔ∏è –Ω–æ–≤–æ—Å—Ç—è–º –ø—Ä–æ –§–†–°, —Å—Ç–∞–≤–∫–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –î–ö–ü (–î–µ–Ω–µ–∂–Ω–æ-–ö—Ä–µ–¥–∏—Ç–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏).

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ—Ü–µ–Ω–∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä—ã–Ω–æ–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç. –û—Ç–≤–µ—Ç—å –Ω–∞ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞:
1. –ö–∞–∫–∏–µ —Å–¥–µ–ª–∫–∏ —Å—Ç–æ–∏—Ç –∏–∑–±–µ–≥–∞—Ç—å?
2. –ë—É–¥–µ—Ç –ª–∏ —Ä–æ—Å—Ç –∏–ª–∏ –ø–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã?

üîπ **–í–æ–∑–≤—Ä–∞—Ç null —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏**:
- –ù–æ–≤–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ —Å—Ç–∞—Ä–æ–π.
- –ù–æ–≤–æ—Å—Ç—å –Ω–∏–∫–∞–∫ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä—ã–Ω–æ–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.

üîπ **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞** (–µ—Å–ª–∏ –Ω–µ null):
- –ë–µ–∑ –≤–≤–æ–¥–Ω—ã—Ö —Å–ª–æ–≤ ("–û—Ç–≤–µ—Ç:", "–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–ª:" –∏ —Ç.–¥.).
- –ò—Å–ø–æ–ª—å–∑—É–π Markdown: *bold text*, _italic text_.
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–∫–µ—Ä—ã.
- –£–∫–∞–∂–∏ —Ç–µ–º—É –Ω–æ–≤–æ—Å—Ç–∏.

üî∏ **–ò–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π:**
- üî∞üî∞üî∞ —Ä–æ—Å—Ç
- üîªüîªüîª –ø–∞–¥–µ–Ω–∏–µ
- ‚ùì –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
- üí∏‚ö†Ô∏è‚ÄºÔ∏è –§–†–°
- ‚ö†Ô∏è‚ÄºÔ∏èüîªüîªüîª –î–µ–ª–∏—Å—Ç–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤ (—Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ)

üî∏ **–í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã:**
- üêïüêïüêï DOGE
- üíé Ethereum (ETH)

–ü—Ä–∏–º–µ—Ä:
"
üî∞üî∞üî∞

üî•*–¢–µ–º–∞:*

üìå –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–æ–∫–µ–Ω—ã:
"

üìå **–î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**:

**–°—Ç–∞—Ä—ã–µ –Ω–æ–≤–æ—Å—Ç–∏**:
{old_news}

üî∏ **–í –∫–æ–Ω—Ü–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –Ω–æ–≤–æ—Å—Ç—å—é.
"""

    response = await client.chat.completions.create(
        model="openai/chatgpt-4o-latest",
        messages=[
            {"role": "system", "content": inst},
            {"role": "user", "content": combined_text}
        ],
        max_tokens=2048,
    )

    return response.choices[0].message.content.strip()

#


async def analyze_trading_signals(df,
                                  finish,
                                  divergence_convergence_signal,
                                  price_action_pattern,
                                  symbol,
                                  timeframe,
                                  buy_price
                            ):
    news_data = get_file_text('news')
    last_values = df.iloc[-1]

    signal_data = f"""
    Buy_price: {buy_price}
    RSI: {last_values['rsi']}
    EMA(21): {last_values['ema21']}
    EMA(49): {last_values['ema49']}
    PPO: {last_values['ppoT']} / {last_values['ppoB']}
    PPO % Rank: {last_values['pctRankT']} / {last_values['pctRankB']}
    VSA: {last_values['vsa_signal']}
    PA Pattern: {price_action_pattern}
    RSI Signal: {last_values['signal_rsi']}
    CM_Laguerre PPO PR Market Tops/Bottoms: {finish}
    Divergence/Convergence Signal: {divergence_convergence_signal if divergence_convergence_signal else "None"}
    """

    prompt = f"""
    Analyze the provided market data and news, then generate a detailed trading signal in the following JSON format:

    {{
        "pair": "{symbol}",
        "signal_type": "Long üî∞" or "Short üîª",
        "timeframe": "{timeframe}",
        "entry_point": "entry price$",
        "take_profit": "TP price$",
        "stop_loss": "SL price$",
        "timestamp": "current date and time in dd-mm-YYYY HH:MM format"
    }}

    Indicators:
    {signal_data}

    News:
    {news_data}

    Determine if the signals are bullish (Long) or bearish (Short), set realistic entry, take-profit, and stop-loss prices accordingly.

    Respond strictly with the JSON only.
    """

    response = await client.chat.completions.create(
        model="openai/gpt-4o-mini",
        messages=[{"role": "user", "content": [{"type": "text", "text": prompt}]}],
        max_tokens=512,
    )

    return response.choices[0].message.content.strip()
